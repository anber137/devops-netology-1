## Практика по занятию «2.3. Ветвления в Git»

Исправление в README, когда в соседней ветке он тоже изменён

C5
C6
C3
C8
C9
C4
C10

## Практика по занятию «2.4. Инструменты Git»

В Linux всё есть в коробке, в Windows надо установить Git и Gpg4win (его [просит](https://www.jetbrains.com/help/pycharm/set-up-gpg-commit-signing.html) PyCharm)

```
winget install git
winget install Gpg4win
``` 

### Создать пару ключей

Делал в WSL, в интерактивном режиме по видео из лекции: `gpg --full-gen-key`

* RSA (sign only), вариант 4
* Keysize: 4096, требование GitHub
* Валиден года на три

### Настроить GPG в Linux/WSL

[Добавить](https://stackoverflow.com/questions/63793836/unable-to-commit-to-git-with-the-gpg-key-error) в `~/.bashrc` две строки
```
GPG_TTY=$(tty)
export GPG_TTY
```

В лекции и [гайде от GitHub](https://docs.github.com/en/enterprise/2.14/user/articles/generating-a-new-gpg-key):
1. `$ gpg --list-secret-keys --keyid-format LONG`
1. `git config --global user.signingkey ОЧЕНЬ_ДЛИННЫЙ_ХЭШ`

### Настроить в Windows

Чтобы не плодить ключи, экспортировал из Linux/WSL и импортировал на Windows. 

Первые два шага делал [по этой ссылке](https://stackoverflow.com/questions/5587513/how-to-export-private-secret-asc-key-to-decrypt-gpg-files).

1. Найти хэш ключа
   
        $ gpg --list-keys
        /home/sergey/.gnupg/pubring.kbx
        -------------------------------
        pub   rsa4096 2021-08-08 [SC] [expires: 2024-08-07]
              DASD980D8S9A0890SDJKLJKLSDMCXVUIXCVYUDSF
        uid           [ultimate] Sergey Shadurskiy <s.shadurskiy@gmail.com>

1. Экспортировать
   
        gpg --export-secret-keys --armor DASD980D8S9A0890SDJKLJKLSDMCXVUIXCVYUDSF > secret.asc

1. Скопировать, например, на рабочий стол, из WSL путь будет такой: `/mnt/c/Users/.../Desktop`

1. Открыть Kleopatra (ставится с Gpg4Win) и испортировать файл `secret.asc`

### Настроить на другом Linux или в Bash Terminal Windows

Конкретно для PyCharm это не потребовалось, оказалось достаточно сделать по их доке.

[По этой статье](https://makandracards.com/makandra-orga/37763-gpg-extract-private-key-and-import-on-different-machine).

Linux/WSL
1. `gpg --list-secret-keys`
1. `gpg --export-secret-keys DASD980D8S9A0890SDJKLJKLSDMCXVUIXCVYUDSF > private.key`

Другой Linux
1. `gpg --import private.key`

### Выбор GPG из PyCharm

Добавлено [пару лет назад](https://youtrack.jetbrains.com/issue/IDEA-110261), эквивалент `git commit -S ...`. В настройках должен быть интерфейс выбора ключа, но почему-то у меня нет. Может потому что ключ один, может потому что PyCharm Community.

Фактический, подписывается автоматом после всех настроек, в самом Пайчарме что-то настривать не потребовалось.

В целом в [их доке](https://www.jetbrains.com/help/pycharm/set-up-gpg-commit-signing.html) всё описано, а выше, чтобы не забыть, расписал, что именно делал. 

В доке JetBrains не хватает: 
* скриншота, который есть в трекере, очень наглядный 
* информации почему опции может не быть, хотя всё работает (я так и не понял, у меня только предположения) 
* информации про Клеопатру: ключ нужно добавлять в ней, а не в терминале Git, там можно вообще не добавлять

### Решенные проблемы

#### Какая-то ошибка, воспроизвести

Решилось настройкой .bashrc

#### Error: “signing failed: No secret key”

[По ссылке](https://medium.com/bootstart/signed-commits-ec2cab9e7254)

#### error: gpg failed to sign the data

`git config --global user.signingkey ДЛИНЮЩИЙ_ХЭЩ`

Почему-то если делать по видео, использваоть короткий хэш, то в Linux работает, а в Windows нифига, PyCharm не мог найти ключ.

### Не решенные

Не понятно как все-такие работает gpg в Windows. 

git bash и kleopatra в windows. git bash как-то задействует  .gnupg/ в домашней директории, но так же создаёт и AppData/Roaming/gnupg и там какие-то файлы, kleopatra вроде обращается только к appdada. если импортить .key через git bsh gpg, то pycharm вроде перестаёт ругаться на ключ, но очень долго думает при создании комита и ничего не делает по факту, и клеопатра ключа не видет. если импортить через клеопатру - все работает. wtf?!

### Подписать предыдущие коммиты

Git rebase. [Тут написано как](https://superuser.com/questions/397149/can-you-gpg-sign-old-commits)

Вкратце: подпись коммита изменит содержимое, то есть хеши в дереве, то есть просто переподписать невозможно, но `rebase` поможет сохранить историю и добавить подписи.